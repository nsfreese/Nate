/* not board certified MDs by Liv decile, excluding PCPs */

Select 
(10-ceiling(liv_prct.prct_rank/10)) as decile, 
count(distinct liv_prct.npi)

	From(
		Select 
        liv.npi, 
        liv.rank, 
        floor(100 * (liv.rank / specialty_counts.n)) as prct_rank
		
		From(
			Select liv.specialty as specialty, count(distinct liv.npi) as n
			From test.livingstone_06_05 liv
			Group by specialty
		) specialty_counts

		Join test.livingstone_06_05 liv
		On specialty_counts.specialty = liv.specialty
	) liv_prct

Join sophia.GR_Master mast On liv_prct.npi = mast.npi
Join sophia.GR_MD_Score scores On mast.group_key = scores.group_key

Where 
scores.board_cert = -30
And scores.prct_rank is not null
And mast.specialty <> "Internal Medicine"
And mast.specialty <> "Family Medicine"

Group by decile
Order by decile Desc;



/* high opioid users by Liv quality decile */

Select (10-ceiling(liv_prct.prct_rank/10)) as decile, count(distinct liv_prct.npi)

	From(
		Select liv.npi, liv.rank, floor(100 * (liv.rank / specialty_counts.n)) as prct_rank
		
		From(
			Select liv.specialty as specialty, count(distinct liv.npi) as n
			From test.livingstone_06_05 liv
			Group by specialty
		) specialty_counts

		Join test.livingstone_06_05 liv
		On specialty_counts.specialty = liv.specialty
	) liv_prct

Join sophia.GR_Master mast On liv_prct.npi = mast.npi
Join sophia.GR_MD_Score scores On mast.group_key = scores.group_key
Where (scores.opioids = -10) And scores.prct_rank is not null
Group by decile
Order by decile Desc;
